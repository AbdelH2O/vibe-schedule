# Data Model: Definition Mode - Context Management

**Date**: 2026-01-18 | **Branch**: `002-context-management`

## Overview

This document describes the data model for Context management. The types are already defined in `lib/types.ts` from Phase 1 implementation.

## Entities

### Context

The primary entity for organizing work focus areas.

```typescript
interface Context {
  id: string;                      // Unique identifier (UUID format)
  name: string;                    // Required, non-empty display name
  priority: number;                // 1-5, where 1 = highest priority, 5 = lowest
  minDuration?: number;            // Optional minimum time allocation (minutes)
  maxDuration?: number;            // Optional maximum time allocation (minutes)
  weight: number;                  // Relative weight for time distribution (default: 1)
  importantDates?: ImportantDate[]; // Optional list of deadlines/milestones
  createdAt: string;               // ISO 8601 timestamp
  updatedAt: string;               // ISO 8601 timestamp
}
```

**Field Details**:

| Field | Type | Required | Default | Validation |
|-------|------|----------|---------|------------|
| id | string | Auto | UUID | Auto-generated by store |
| name | string | Yes | - | Non-empty string |
| priority | number | No | 3 | Integer 1-5 |
| minDuration | number | No | undefined | Positive integer, ≤ maxDuration if both set |
| maxDuration | number | No | undefined | Positive integer, ≥ minDuration if both set |
| weight | number | No | 1 | Positive number (decimals allowed) |
| importantDates | ImportantDate[] | No | [] | Array of valid ImportantDate objects |
| createdAt | string | Auto | now() | ISO 8601 format |
| updatedAt | string | Auto | now() | ISO 8601 format, updated on any change |

### ImportantDate

A deadline or milestone associated with a Context.

```typescript
interface ImportantDate {
  id: string;    // Unique identifier within the context
  label: string; // Descriptive name for the date
  date: string;  // ISO date string (YYYY-MM-DD)
}
```

**Field Details**:

| Field | Type | Required | Validation |
|-------|------|----------|------------|
| id | string | Auto | UUID, unique within parent context |
| label | string | Yes | Non-empty string |
| date | string | Yes | Valid ISO date (YYYY-MM-DD) |

## State Management

### Store Actions

Context operations available from `useStore()` hook:

```typescript
// Create a new context
addContext(context: Omit<Context, 'id' | 'createdAt' | 'updatedAt'>): void

// Update existing context (partial update)
updateContext(id: string, updates: Partial<Context>): void

// Delete context (moves tasks to Inbox)
deleteContext(id: string): void

// Get context by ID
getContextById(id: string): Context | undefined
```

### Selector Usage

```typescript
// Get all contexts
const { state } = useStore();
const contexts = state.contexts;

// Get single context
const { getContextById } = useStore();
const context = getContextById(contextId);

// Get tasks for a context
const { getTasksByContextId } = useStore();
const tasks = getTasksByContextId(contextId);
```

## Data Flow

### Create Context Flow

```
User Action          → Store Dispatch           → State Update        → localStorage
─────────────────────────────────────────────────────────────────────────────────
Submit form          → ADD_CONTEXT              → contexts.push()     → saveState()
with name,           → { payload: {             → with auto id,       → persists
priority, etc.          name, priority, ... }}    timestamps          → full state
```

### Update Context Flow

```
User Action          → Store Dispatch           → State Update        → localStorage
─────────────────────────────────────────────────────────────────────────────────
Edit & save          → UPDATE_CONTEXT           → contexts.map()      → saveState()
                     → { id, updates }          → merge updates,      → persists
                                                   refresh updatedAt
```

### Delete Context Flow

```
User Action          → Store Dispatch           → State Update        → localStorage
─────────────────────────────────────────────────────────────────────────────────
Confirm delete       → DELETE_CONTEXT           → contexts.filter()   → saveState()
                     → { payload: id }          → tasks.map()         → persists
                                                   (contextId→null)
```

## Persistence

All state is persisted to localStorage under key `vibe-schedule-state`.

**Storage Format**:
```json
{
  "contexts": [...],
  "tasks": [...],
  "mode": "definition",
  "session": null
}
```

**Hydration**: On app mount, `StoreProvider` loads from localStorage and dispatches `HYDRATE` action.

**Sync**: Every state change triggers `saveState()` via useEffect (debounced by React's batching).

## Relationships

```
Context (1) ←──────────── (n) Task
    │                          │
    │                          └── contextId: string | null
    │                                (null = Inbox)
    │
    └── importantDates: ImportantDate[]
            (embedded, not separate entity)
```

## Computed Properties

These are calculated at render time, not stored:

### Days Remaining (ImportantDate)

```typescript
function getDaysRemaining(date: string): number {
  const target = new Date(date);
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  target.setHours(0, 0, 0, 0);
  return Math.ceil((target.getTime() - today.getTime()) / (1000 * 60 * 60 * 24));
}
```

**Display Logic**:
- `days > 7`: Show "X days" in neutral style
- `days > 0 && days <= 7`: Show "X days" in warning style (soon indicator)
- `days <= 0`: Show "Overdue" in error style

### Task Count (Context)

```typescript
function getTaskCount(contextId: string): number {
  return state.tasks.filter(t => t.contextId === contextId).length;
}
```

### Completed Task Count (Context)

```typescript
function getCompletedTaskCount(contextId: string): number {
  return state.tasks.filter(t => t.contextId === contextId && t.completed).length;
}
```
